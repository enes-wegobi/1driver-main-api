<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test Dashboard - Driver & Customer</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 800px;
        }

        .panel {
            padding: 30px;
            border-right: 1px solid #eee;
        }

        .panel:last-child {
            border-right: none;
        }

        .panel-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .panel-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
            color: white;
        }

        .driver-panel .panel-icon {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .customer-panel .panel-icon {
            background: linear-gradient(135deg, #4834d4, #686de0);
        }

        .panel-title {
            font-size: 1.8em;
            font-weight: 600;
            color: #2c3e50;
        }

        .connection-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 184, 148, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(253, 203, 110, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #00b894;
            box-shadow: 0 0 10px rgba(0, 184, 148, 0.5);
        }

        .status-disconnected {
            background: #ff6b6b;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        .status-connecting {
            background: #fdcb6e;
            box-shadow: 0 0 10px rgba(253, 203, 110, 0.5);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .location-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .location-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .logs-section {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 4px;
        }

        .log-info {
            background: rgba(52, 152, 219, 0.2);
            border-left: 3px solid #3498db;
        }

        .log-success {
            background: rgba(46, 204, 113, 0.2);
            border-left: 3px solid #2ecc71;
        }

        .log-warning {
            background: rgba(241, 196, 15, 0.2);
            border-left: 3px solid #f1c40f;
        }

        .log-error {
            background: rgba(231, 76, 60, 0.2);
            border-left: 3px solid #e74c3c;
        }

        .timestamp {
            color: #95a5a6;
            font-size: 11px;
        }

        .availability-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .availability-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }

        .status-busy {
            background: #95a5a6;
            color: white;
        }

        .status-available {
            background: #2ecc71;
            color: white;
        }

        .status-busy {
            background: #e74c3c;
            color: white;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ecf0f1;
        }

        .clear-logs {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .clear-logs:hover {
            background: rgba(255,255,255,0.2);
        }

        .logs-container {
            position: relative;
        }

        .auto-location {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .auto-location h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .location-info {
            font-size: 12px;
            color: #0c5460;
            margin-bottom: 10px;
        }

        .location-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .panel {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
            
            .panel:last-child {
                border-bottom: none;
            }
            
            .location-controls {
                flex-direction: column;
            }
            
            .location-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó WebSocket Test Dashboard</h1>
            <p>Driver & Customer WebSocket Baƒülantƒ± Test Aracƒ± - Gateway Uyumlu</p>
        </div>

        <div class="main-content">
            <!-- Driver Panel -->
            <div class="panel driver-panel">
                <div class="panel-header">
                    <div class="panel-icon">üöó</div>
                    <div class="panel-title">Driver Panel</div>
                </div>

                <div class="connection-section">
                    <div class="section-title">Driver Login</div>
                    
                    <div class="form-group">
                        <label>API Base URL:</label>
                        <input type="text" id="driverApiUrl" value="http://localhost:3000">
                    </div>

                    <div class="form-group">
                        <label>Phone Number:</label>
                        <input type="text" id="driverPhone" placeholder="+905551234567">
                    </div>

                    <div class="form-group" id="driverOtpGroup" style="display: none;">
                        <label>OTP Code:</label>
                        <input type="text" id="driverOtp" placeholder="123456" maxlength="6">
                    </div>

                    <div class="availability-controls">
                        <button class="btn btn-primary" onclick="initiateDriverLogin()" id="driverLoginBtn">Login</button>
                        <button class="btn btn-success" onclick="completeDriverLogin()" id="driverOtpBtn" style="display: none;">Verify OTP</button>
                        <button class="btn btn-warning" onclick="resendDriverOtp()" id="driverResendBtn" style="display: none;">Resend OTP</button>
                    </div>

                    <div class="form-group" id="driverTokenGroup" style="display: none;">
                        <label>Generated Token:</label>
                        <textarea id="driverTokenDisplay" readonly rows="3" style="font-family: monospace; font-size: 11px; word-break: break-all;"></textarea>
                        <button class="btn btn-primary" onclick="copyDriverToken()" style="margin-top: 5px;">Copy Token</button>
                    </div>
                </div>

                <div class="connection-section">
                    <div class="section-title">WebSocket Baƒülantƒ±</div>
                    
                    <div class="form-group">
                        <label>WebSocket URL:</label>
                        <input type="text" id="driverUrl" value="ws://localhost:3000">
                    </div>

                    <div class="form-group">
                        <label>Driver Token (Manuel):</label>
                        <input type="text" id="driverToken" placeholder="JWT Token girin veya yukarƒ±dan login yapƒ±n">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <span class="status-indicator" id="driverStatus"></span>
                        <span id="driverStatusText">Baƒülantƒ± Yok</span>
                    </div>

                    <button class="btn btn-primary" onclick="connectDriver()">Baƒülan</button>
                    <button class="btn btn-danger" onclick="disconnectDriver()">Baƒülantƒ±yƒ± Kes</button>
                </div>

                <div class="section-title">Driver Availability Status</div>
                <div class="availability-controls">
                    <button class="btn btn-warning" onclick="updateDriverAvailability('busy')">BUSY</button>
                    <button class="btn btn-success" onclick="updateDriverAvailability('available')">AVAILABLE</button>
                </div>
                <div id="driverAvailabilityStatus" class="availability-status status-busy">BUSY</div>

                <div class="section-title">App State</div>
                <div class="form-group">
                    <label>Current App State:</label>
                    <select id="driverAppState">
                        <option value="active">ACTIVE</option>
                        <option value="background">BACKGROUND</option>
                        <option value="inactive">INACTIVE</option>
                    </select>
                </div>

                <div class="section-title">Heartbeat Kontrol√º</div>
                <div class="availability-controls">
                    <button class="btn btn-primary" onclick="sendDriverHeartbeat()">Manuel Heartbeat G√∂nder</button>
                    <button class="btn btn-success" onclick="toggleDriverAutoHeartbeat()" id="driverAutoHeartbeatBtn">Otomatik Heartbeat Ba≈ülat</button>
                </div>
                <div id="driverHeartbeatStatus" class="location-info">Heartbeat durumu: Kapalƒ±</div>

                <div class="location-section">
                    <div class="section-title">Konum Kontrol√º</div>
                    
                    <div class="auto-location">
                        <h4>üåç Otomatik Konum</h4>
                        <div class="location-info" id="driverLocationInfo">Konum bilgisi alƒ±nmadƒ±</div>
                        <button class="btn btn-primary" onclick="getDriverLocation()">GPS Konumu Al</button>
                    </div>

                    <div class="location-grid">
                        <div class="form-group">
                            <label>Latitude:</label>
                            <input type="number" id="driverLat" step="any" value="41.0082">
                        </div>
                        <div class="form-group">
                            <label>Longitude:</label>
                            <input type="number" id="driverLng" step="any" value="28.9784">
                        </div>
                        <div class="form-group">
                            <label>Speed (km/h):</label>
                            <input type="number" id="driverSpeed" step="any" value="0">
                        </div>
                        <div class="form-group">
                            <label>Heading (¬∞):</label>
                            <input type="number" id="driverHeading" step="any" value="0">
                        </div>
                    </div>

                    <div class="location-controls">
                        <button class="btn btn-primary" onclick="sendDriverLocationUpdate()">üìç Manuel Konum G√∂nder</button>
                        <button class="btn btn-success" onclick="toggleDriverAutoLocation()" id="driverAutoLocationBtn">Otomatik Konum Ba≈ülat</button>
                    </div>

                    <div class="location-info">‚ÑπÔ∏è Konum heartbeat ile de otomatik g√∂nderilir</div>
                    <div id="driverLocationStatus" class="location-info">Otomatik konum: Kapalƒ±</div>
                </div>

                <div class="logs-container">
                    <div class="section-title">Driver Logs</div>
                    <div class="logs-section" id="driverLogs">
                        <button class="clear-logs" onclick="clearLogs('driver')">Temizle</button>
                        <div class="log-entry log-info">
                            <span class="timestamp">[Ba≈ülatƒ±ldƒ±]</span> Driver panel hazƒ±r
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Panel -->
            <div class="panel customer-panel">
                <div class="panel-header">
                    <div class="panel-icon">üë§</div>
                    <div class="panel-title">Customer Panel</div>
                </div>

                <div class="connection-section">
                    <div class="section-title">Customer Login</div>
                    
                    <div class="form-group">
                        <label>API Base URL:</label>
                        <input type="text" id="customerApiUrl" value="http://localhost:3000">
                    </div>

                    <div class="form-group">
                        <label>Phone Number:</label>
                        <input type="text" id="customerPhone" placeholder="+905551234567">
                    </div>

                    <div class="form-group" id="customerOtpGroup" style="display: none;">
                        <label>OTP Code:</label>
                        <input type="text" id="customerOtp" placeholder="123456" maxlength="6">
                    </div>

                    <div class="availability-controls">
                        <button class="btn btn-primary" onclick="initiateCustomerLogin()" id="customerLoginBtn">Login</button>
                        <button class="btn btn-success" onclick="completeCustomerLogin()" id="customerOtpBtn" style="display: none;">Verify OTP</button>
                        <button class="btn btn-warning" onclick="resendCustomerOtp()" id="customerResendBtn" style="display: none;">Resend OTP</button>
                    </div>

                    <div class="form-group" id="customerTokenGroup" style="display: none;">
                        <label>Generated Token:</label>
                        <textarea id="customerTokenDisplay" readonly rows="3" style="font-family: monospace; font-size: 11px; word-break: break-all;"></textarea>
                        <button class="btn btn-primary" onclick="copyCustomerToken()" style="margin-top: 5px;">Copy Token</button>
                    </div>
                </div>

                <div class="connection-section">
                    <div class="section-title">WebSocket Baƒülantƒ±</div>
                    
                    <div class="form-group">
                        <label>WebSocket URL:</label>
                        <input type="text" id="customerUrl" value="ws://localhost:3000">
                    </div>

                    <div class="form-group">
                        <label>Customer Token (Manuel):</label>
                        <input type="text" id="customerToken" placeholder="JWT Token girin veya yukarƒ±dan login yapƒ±n">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <span class="status-indicator" id="customerStatus"></span>
                        <span id="customerStatusText">Baƒülantƒ± Yok</span>
                    </div>

                    <button class="btn btn-primary" onclick="connectCustomer()">Baƒülan</button>
                    <button class="btn btn-danger" onclick="disconnectCustomer()">Baƒülantƒ±yƒ± Kes</button>
                </div>

                <div class="section-title">App State</div>
                <div class="form-group">
                    <label>Current App State:</label>
                    <select id="customerAppState">
                        <option value="active">ACTIVE</option>
                        <option value="background">BACKGROUND</option>
                        <option value="inactive">INACTIVE</option>
                    </select>
                </div>

                <div class="section-title">Heartbeat Kontrol√º</div>
                <div class="availability-controls">
                    <button class="btn btn-primary" onclick="sendCustomerHeartbeat()">Manuel Heartbeat G√∂nder</button>
                    <button class="btn btn-success" onclick="toggleCustomerAutoHeartbeat()" id="customerAutoHeartbeatBtn">Otomatik Heartbeat Ba≈ülat</button>
                </div>
                <div id="customerHeartbeatStatus" class="location-info">Heartbeat durumu: Kapalƒ±</div>

                <div class="location-section">
                    <div class="section-title">Konum Kontrol√º</div>
                    
                    <div class="auto-location">
                        <h4>üåç Otomatik Konum</h4>
                        <div class="location-info" id="customerLocationInfo">Konum bilgisi alƒ±nmadƒ±</div>
                        <button class="btn btn-primary" onclick="getCustomerLocation()">GPS Konumu Al</button>
                    </div>

                    <div class="location-grid">
                        <div class="form-group">
                            <label>Latitude:</label>
                            <input type="number" id="customerLat" step="any" value="41.0082">
                        </div>
                        <div class="form-group">
                            <label>Longitude:</label>
                            <input type="number" id="customerLng" step="any" value="28.9784">
                        </div>
                        <div class="form-group">
                            <label>Accuracy (m):</label>
                            <input type="number" id="customerAccuracy" step="any" value="10">
                        </div>
                        <div class="form-group">
                            <label>Altitude (m):</label>
                            <input type="number" id="customerAltitude" step="any" value="0">
                        </div>
                    </div>

                    <div class="location-controls">
                        <button class="btn btn-primary" onclick="sendCustomerLocationUpdate()">üìç Manuel Konum G√∂nder</button>
                        <button class="btn btn-success" onclick="toggleCustomerAutoLocation()" id="customerAutoLocationBtn">Otomatik Konum Ba≈ülat</button>
                    </div>

                    <div class="location-info">‚ÑπÔ∏è Konum heartbeat ile de otomatik g√∂nderilir</div>
                    <div id="customerLocationStatus" class="location-info">Otomatik konum: Kapalƒ±</div>
                </div>

                <div class="logs-container">
                    <div class="section-title">Customer Logs</div>
                    <div class="logs-section" id="customerLogs">
                        <button class="clear-logs" onclick="clearLogs('customer')">Temizle</button>
                        <div class="log-entry log-info">
                            <span class="timestamp">[Ba≈ülatƒ±ldƒ±]</span> Customer panel hazƒ±r
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let driverSocket = null;
        let customerSocket = null;
        let driverHeartbeatInterval = null;
        let customerHeartbeatInterval = null;
        let driverLocationInterval = null;
        let customerLocationInterval = null;

        // App States
        const AppState = {
            ACTIVE: 'active',
            BACKGROUND: 'background',
            INACTIVE: 'inactive'
        };

        // Utility Functions
        function getCurrentTimestamp() {
            return new Date().toLocaleTimeString('tr-TR');
        }

        function addLog(panel, type, message) {
            const logsContainer = document.getElementById(`${panel}Logs`);
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="timestamp">[${getCurrentTimestamp()}]</span> ${message}`;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function clearLogs(panel) {
            const logsContainer = document.getElementById(`${panel}Logs`);
            logsContainer.innerHTML = '<button class="clear-logs" onclick="clearLogs(\'' + panel + '\')">Temizle</button>';
        }

        function updateHeartbeatStatus(panel, status) {
            const statusElement = document.getElementById(`${panel}HeartbeatStatus`);
            statusElement.textContent = status;
        }

        function updateLocationStatus(panel, status) {
            const statusElement = document.getElementById(`${panel}LocationStatus`);
            statusElement.textContent = status;
        }

        function updateConnectionStatus(panel, status) {
            const statusIndicator = document.getElementById(`${panel}Status`);
            const statusText = document.getElementById(`${panel}StatusText`);
            
            statusIndicator.className = `status-indicator status-${status}`;
            
            switch(status) {
                case 'connected':
                    statusText.textContent = 'Baƒülƒ±';
                    break;
                case 'connecting':
                    statusText.textContent = 'Baƒülanƒ±yor...';
                    break;
                case 'disconnected':
                    statusText.textContent = 'Baƒülantƒ± Yok';
                    break;
            }
        }

        // Driver Functions
        function connectDriver() {
            const url = document.getElementById('driverUrl').value;
            const token = document.getElementById('driverToken').value;

            if (!token) {
                addLog('driver', 'error', 'Token gerekli!');
                return;
            }

            updateConnectionStatus('driver', 'connecting');
            addLog('driver', 'info', `Baƒülanƒ±yor: ${url}`);

            driverSocket = io(url, {
                auth: { token: token },
                transports: ['websocket']
            });

            driverSocket.on('connect', () => {
                updateConnectionStatus('driver', 'connected');
                addLog('driver', 'success', `Baƒülantƒ± ba≈üarƒ±lƒ±! Socket ID: ${driverSocket.id}`);
            });

            driverSocket.on('connection', (data) => {
                addLog('driver', 'success', `Kimlik doƒürulama ba≈üarƒ±lƒ±: ${JSON.stringify(data)}`);
                if (data.availabilityStatus) {
                    updateDriverAvailabilityDisplay(data.availabilityStatus);
                }
                if (data.heartbeatInterval) {
                    addLog('driver', 'info', `Heartbeat interval: ${data.heartbeatInterval}ms`);
                }
            });

            // Heartbeat acknowledgment
            driverSocket.on('heartbeat-ack', (data) => {
                addLog('driver', 'success', `üíì Heartbeat ACK: ${JSON.stringify(data)}`);
                updateHeartbeatStatus('driver', 'Heartbeat ba≈üarƒ±lƒ± - ' + new Date().toLocaleTimeString());
            });

            driverSocket.on('disconnect', () => {
                updateConnectionStatus('driver', 'disconnected');
                addLog('driver', 'warning', 'Baƒülantƒ± kesildi');
            });

            driverSocket.on('error', (error) => {
                addLog('driver', 'error', `Hata: ${JSON.stringify(error)}`);
            });

            // Driver specific events
            driverSocket.on('driver:location_updated', (data) => {
                addLog('driver', 'info', `Konum g√ºncellendi: ${JSON.stringify(data)}`);
            });

            driverSocket.on('driver:status_changed', (data) => {
                addLog('driver', 'info', `Status deƒüi≈üti: ${JSON.stringify(data)}`);
            });

            // Trip events
            driverSocket.on('trip:requested', (data) => {
                addLog('driver', 'info', `üöó Yeni trip talebi: ${JSON.stringify(data)}`);
            });

            driverSocket.on('trip:driver_assigned', (data) => {
                addLog('driver', 'success', `‚úÖ Trip atandƒ±: ${JSON.stringify(data)}`);
            });

            driverSocket.on('trip:cancelled', (data) => {
                addLog('driver', 'warning', `‚ùå Trip iptal edildi: ${JSON.stringify(data)}`);
            });

            driverSocket.on('trip:completed', (data) => {
                addLog('driver', 'success', `üèÅ Trip tamamlandƒ±: ${JSON.stringify(data)}`);
            });

            // Generic event listener for all events
            driverSocket.onAny((eventName, data) => {
                if (!['connect', 'disconnect', 'connection', 'error'].includes(eventName)) {
                    addLog('driver', 'info', `üì° Event: ${eventName} - ${JSON.stringify(data)}`);
                }
            });
        }

        function disconnectDriver() {
            if (driverSocket) {
                driverSocket.disconnect();
                driverSocket = null;
                updateConnectionStatus('driver', 'disconnected');
                addLog('driver', 'info', 'Baƒülantƒ± kapatƒ±ldƒ±');
            }
            
            // Stop all intervals
            if (driverHeartbeatInterval) {
                clearInterval(driverHeartbeatInterval);
                driverHeartbeatInterval = null;
                document.getElementById('driverAutoHeartbeatBtn').textContent = 'Otomatik Heartbeat Ba≈ülat';
                updateHeartbeatStatus('driver', 'Heartbeat durumu: Kapalƒ±');
            }

            if (driverLocationInterval) {
                clearInterval(driverLocationInterval);
                driverLocationInterval = null;
                document.getElementById('driverAutoLocationBtn').textContent = 'Otomatik Konum Ba≈ülat';
                updateLocationStatus('driver', 'Otomatik konum: Kapalƒ±');
            }
        }

        function updateDriverAvailability(status) {
            if (!driverSocket || !driverSocket.connected) {
                addLog('driver', 'error', '√ñnce baƒülantƒ± kurmalƒ±sƒ±nƒ±z!');
                return;
            }

            addLog('driver', 'info', `Availability status g√ºncelleniyor: ${status}`);
            
            driverSocket.emit('updateDriverAvailability', { status: status }, (response) => {
                if (response) {
                    if (response.success) {
                        addLog('driver', 'success', `Availability g√ºncellendi: ${response.status}`);
                        updateDriverAvailabilityDisplay(response.status);
                    } else {
                        addLog('driver', 'error', `Availability g√ºncellenemedi: ${response.message}`);
                    }
                }
            });
        }

        function updateDriverAvailabilityDisplay(status) {
            const statusElement = document.getElementById('driverAvailabilityStatus');
            statusElement.textContent = status.toUpperCase();
            statusElement.className = `availability-status status-${status}`;
        }

        function getDriverLocation() {
            if (navigator.geolocation) {
                addLog('driver', 'info', 'GPS konumu alƒ±nƒ±yor...');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        const speed = position.coords.speed || 0;
                        const heading = position.coords.heading || 0;

                        document.getElementById('driverLat').value = lat;
                        document.getElementById('driverLng').value = lng;
                        document.getElementById('driverSpeed').value = speed;
                        document.getElementById('driverHeading').value = heading;

                        document.getElementById('driverLocationInfo').textContent = 
                            `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}, Accuracy: ${accuracy}m`;

                        addLog('driver', 'success', `GPS konum alƒ±ndƒ±: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                    },
                    (error) => {
                        addLog('driver', 'error', `GPS hatasƒ±: ${error.message}`);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
            } else {
                addLog('driver', 'error', 'Geolocation desteklenmiyor');
            }
        }

        // NEW: Driver Location Update Function (Gateway compatible)
        function sendDriverLocationUpdate() {
            if (!driverSocket || !driverSocket.connected) {
                addLog('driver', 'error', '√ñnce baƒülantƒ± kurmalƒ±sƒ±nƒ±z!');
                return;
            }

            const locationData = {
                latitude: parseFloat(document.getElementById('driverLat').value),
                longitude: parseFloat(document.getElementById('driverLng').value),
                speed: parseFloat(document.getElementById('driverSpeed').value) || 0,
                heading: parseFloat(document.getElementById('driverHeading').value) || 0,
                accuracy: 10, // Default accuracy
                timestamp: new Date().toISOString()
            };

            addLog('driver', 'info', `üìç Konum g√ºncelleme g√∂nderiliyor: ${JSON.stringify(locationData)}`);
            
            driverSocket.emit('updateLocation', locationData, (response) => {
                if (response) {
                    if (response.success) {
                        addLog('driver', 'success', `üìç Konum g√ºncellendi ba≈üarƒ±yla`);
                    } else {
                        addLog('driver', 'error', `üìç Konum g√ºncellenemedi: ${response.message}`);
                    }
                }
            });
        }

        // NEW: Toggle Driver Auto Location Updates
        function toggleDriverAutoLocation() {
            if (driverLocationInterval) {
                clearInterval(driverLocationInterval);
                driverLocationInterval = null;
                document.getElementById('driverAutoLocationBtn').textContent = 'Otomatik Konum Ba≈ülat';
                updateLocationStatus('driver', 'Otomatik konum: Kapalƒ±');
                addLog('driver', 'info', 'Otomatik konum g√ºncellemesi durduruldu');
            } else {
                driverLocationInterval = setInterval(() => {
                    if (driverSocket && driverSocket.connected) {
                        sendDriverLocationUpdate();
                    }
                }, 10000); // Her 10 saniyede bir konum g√∂nder
                document.getElementById('driverAutoLocationBtn').textContent = 'Otomatik Konum Durdur';
                updateLocationStatus('driver', 'Otomatik konum: Aktif (10s aralƒ±k)');
                addLog('driver', 'info', 'Otomatik konum g√ºncellemesi ba≈ülatƒ±ldƒ± (10s aralƒ±k)');
            }
        }

        // Customer Functions
        function connectCustomer() {
            const url = document.getElementById('customerUrl').value;
            const token = document.getElementById('customerToken').value;

            if (!token) {
                addLog('customer', 'error', 'Token gerekli!');
                return;
            }

            updateConnectionStatus('customer', 'connecting');
            addLog('customer', 'info', `Baƒülanƒ±yor: ${url}`);

            customerSocket = io(url, {
                auth: { token: token },
                transports: ['websocket']
            });

            customerSocket.on('connect', () => {
                updateConnectionStatus('customer', 'connected');
                addLog('customer', 'success', `Baƒülantƒ± ba≈üarƒ±lƒ±! Socket ID: ${customerSocket.id}`);
            });

            customerSocket.on('connection', (data) => {
                addLog('customer', 'success', `Kimlik doƒürulama ba≈üarƒ±lƒ±: ${JSON.stringify(data)}`);
                if (data.heartbeatInterval) {
                    addLog('customer', 'info', `Heartbeat interval: ${data.heartbeatInterval}ms`);
                }
            });

            // Heartbeat acknowledgment
            customerSocket.on('heartbeat-ack', (data) => {
                addLog('customer', 'success', `üíì Heartbeat ACK: ${JSON.stringify(data)}`);
                updateHeartbeatStatus('customer', 'Heartbeat ba≈üarƒ±lƒ± - ' + new Date().toLocaleTimeString());
            });

            customerSocket.on('disconnect', () => {
                updateConnectionStatus('customer', 'disconnected');
                addLog('customer', 'warning', 'Baƒülantƒ± kesildi');
            });

            customerSocket.on('error', (error) => {
                addLog('customer', 'error', `Hata: ${JSON.stringify(error)}`);
            });

            // Customer specific events
            customerSocket.on('customer:location_updated', (data) => {
                addLog('customer', 'info', `Konum g√ºncellendi: ${JSON.stringify(data)}`);
            });

            // Driver location updates (when in trip)
            customerSocket.on('driver:location_updated', (data) => {
                addLog('customer', 'info', `üöó Driver konum g√ºncellendi: ${JSON.stringify(data)}`);
            });

            // Trip events
            customerSocket.on('trip:driver_assigned', (data) => {
                addLog('customer', 'success', `‚úÖ Driver atandƒ±: ${JSON.stringify(data)}`);
            });

            customerSocket.on('trip:driver_en_route', (data) => {
                addLog('customer', 'info', `üöó Driver yolda: ${JSON.stringify(data)}`);
            });

            customerSocket.on('trip:driver_arrived', (data) => {
                addLog('customer', 'success', `üìç Driver geldi: ${JSON.stringify(data)}`);
            });

            customerSocket.on('trip:started', (data) => {
                addLog('customer', 'info', `üöÄ Trip ba≈üladƒ±: ${JSON.stringify(data)}`);
            });

            customerSocket.on('trip:cancelled', (data) => {
                addLog('customer', 'warning', `‚ùå Trip iptal edildi: ${JSON.stringify(data)}`);
            });

            customerSocket.on('trip:completed', (data) => {
                addLog('customer', 'success', `üèÅ Trip tamamlandƒ±: ${JSON.stringify(data)}`);
            });

            customerSocket.on('trip:payment_required', (data) => {
                addLog('customer', 'warning', `üí≥ √ñdeme gerekli: ${JSON.stringify(data)}`);
            });

            customerSocket.on('trip:payment_success', (data) => {
                addLog('customer', 'success', `‚úÖ √ñdeme ba≈üarƒ±lƒ±: ${JSON.stringify(data)}`);
            });

            customerSocket.on('trip:payment_failed', (data) => {
                addLog('customer', 'error', `‚ùå √ñdeme ba≈üarƒ±sƒ±z: ${JSON.stringify(data)}`);
            });

            // Notification events
            customerSocket.on('notification', (data) => {
                addLog('customer', 'info', `üîî Bildirim: ${JSON.stringify(data)}`);
            });

            // Generic event listener for all events
            customerSocket.onAny((eventName, data) => {
                if (!['connect', 'disconnect', 'connection', 'error'].includes(eventName)) {
                    addLog('customer', 'info', `üì° Event: ${eventName} - ${JSON.stringify(data)}`);
                }
            });
        }

        function disconnectCustomer() {
            if (customerSocket) {
                customerSocket.disconnect();
                customerSocket = null;
                updateConnectionStatus('customer', 'disconnected');
                addLog('customer', 'info', 'Baƒülantƒ± kapatƒ±ldƒ±');
            }
            
            // Stop all intervals
            if (customerHeartbeatInterval) {
                clearInterval(customerHeartbeatInterval);
                customerHeartbeatInterval = null;
                document.getElementById('customerAutoHeartbeatBtn').textContent = 'Otomatik Heartbeat Ba≈ülat';
                updateHeartbeatStatus('customer', 'Heartbeat durumu: Kapalƒ±');
            }

            if (customerLocationInterval) {
                clearInterval(customerLocationInterval);
                customerLocationInterval = null;
                document.getElementById('customerAutoLocationBtn').textContent = 'Otomatik Konum Ba≈ülat';
                updateLocationStatus('customer', 'Otomatik konum: Kapalƒ±');
            }
        }

        function getCustomerLocation() {
            if (navigator.geolocation) {
                addLog('customer', 'info', 'GPS konumu alƒ±nƒ±yor...');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        const altitude = position.coords.altitude || 0;

                        document.getElementById('customerLat').value = lat;
                        document.getElementById('customerLng').value = lng;
                        document.getElementById('customerAccuracy').value = accuracy;
                        document.getElementById('customerAltitude').value = altitude;

                        document.getElementById('customerLocationInfo').textContent = 
                            `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}, Accuracy: ${accuracy}m`;

                        addLog('customer', 'success', `GPS konum alƒ±ndƒ±: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                    },
                    (error) => {
                        addLog('customer', 'error', `GPS hatasƒ±: ${error.message}`);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
            } else {
                addLog('customer', 'error', 'Geolocation desteklenmiyor');
            }
        }

        // NEW: Customer Location Update Function (Gateway compatible)
        function sendCustomerLocationUpdate() {
            if (!customerSocket || !customerSocket.connected) {
                addLog('customer', 'error', '√ñnce baƒülantƒ± kurmalƒ±sƒ±nƒ±z!');
                return;
            }

            const locationData = {
                latitude: parseFloat(document.getElementById('customerLat').value),
                longitude: parseFloat(document.getElementById('customerLng').value),
                accuracy: parseFloat(document.getElementById('customerAccuracy').value) || 10,
                altitude: parseFloat(document.getElementById('customerAltitude').value) || 0,
                timestamp: new Date().toISOString()
            };

            addLog('customer', 'info', `üìç Konum g√ºncelleme g√∂nderiliyor: ${JSON.stringify(locationData)}`);
            
            customerSocket.emit('updateLocation', locationData, (response) => {
                if (response) {
                    if (response.success) {
                        addLog('customer', 'success', `üìç Konum g√ºncellendi ba≈üarƒ±yla`);
                    } else {
                        addLog('customer', 'error', `üìç Konum g√ºncellenemedi: ${response.message}`);
                    }
                }
            });
        }

        // NEW: Toggle Customer Auto Location Updates
        function toggleCustomerAutoLocation() {
            if (customerLocationInterval) {
                clearInterval(customerLocationInterval);
                customerLocationInterval = null;
                document.getElementById('customerAutoLocationBtn').textContent = 'Otomatik Konum Ba≈ülat';
                updateLocationStatus('customer', 'Otomatik konum: Kapalƒ±');
                addLog('customer', 'info', 'Otomatik konum g√ºncellemesi durduruldu');
            } else {
                customerLocationInterval = setInterval(() => {
                    if (customerSocket && customerSocket.connected) {
                        sendCustomerLocationUpdate();
                    }
                }, 15000); // Her 15 saniyede bir konum g√∂nder
                document.getElementById('customerAutoLocationBtn').textContent = 'Otomatik Konum Durdur';
                updateLocationStatus('customer', 'Otomatik konum: Aktif (15s aralƒ±k)');
                addLog('customer', 'info', 'Otomatik konum g√ºncellemesi ba≈ülatƒ±ldƒ± (15s aralƒ±k)');
            }
        }

        // Heartbeat Functions (Updated to include location)
        function sendDriverHeartbeat() {
            if (!driverSocket || !driverSocket.connected) {
                addLog('driver', 'error', '√ñnce baƒülantƒ± kurmalƒ±sƒ±nƒ±z!');
                return;
            }

            const appState = document.getElementById('driverAppState').value;
            const heartbeatData = {
                timestamp: new Date().toISOString(),
                appState: appState,
                location: {
                    latitude: parseFloat(document.getElementById('driverLat').value),
                    longitude: parseFloat(document.getElementById('driverLng').value),
                    speed: parseFloat(document.getElementById('driverSpeed').value) || 0,
                    heading: parseFloat(document.getElementById('driverHeading').value) || 0,
                    accuracy: 10,
                    timestamp: new Date().toISOString()
                }
            };

            addLog('driver', 'info', `üíì Heartbeat g√∂nderiliyor: ${JSON.stringify(heartbeatData)}`);
            
            driverSocket.emit('heartbeat', heartbeatData, (response) => {
                if (response) {
                    if (response.success) {
                        addLog('driver', 'success', `üíì Heartbeat ba≈üarƒ±lƒ±: ${JSON.stringify(response)}`);
                    } else {
                        addLog('driver', 'error', `üíì Heartbeat ba≈üarƒ±sƒ±z: ${response.message}`);
                    }
                }
            });
        }

        function sendCustomerHeartbeat() {
            if (!customerSocket || !customerSocket.connected) {
                addLog('customer', 'error', '√ñnce baƒülantƒ± kurmalƒ±sƒ±nƒ±z!');
                return;
            }

            const appState = document.getElementById('customerAppState').value;
            const heartbeatData = {
                timestamp: new Date().toISOString(),
                appState: appState,
                location: {
                    latitude: parseFloat(document.getElementById('customerLat').value),
                    longitude: parseFloat(document.getElementById('customerLng').value),
                    accuracy: parseFloat(document.getElementById('customerAccuracy').value) || 10,
                    altitude: parseFloat(document.getElementById('customerAltitude').value) || 0,
                    timestamp: new Date().toISOString()
                }
            };

            addLog('customer', 'info', `üíì Heartbeat g√∂nderiliyor: ${JSON.stringify(heartbeatData)}`);
            
            customerSocket.emit('heartbeat', heartbeatData, (response) => {
                if (response) {
                    if (response.success) {
                        addLog('customer', 'success', `üíì Heartbeat ba≈üarƒ±lƒ±: ${JSON.stringify(response)}`);
                    } else {
                        addLog('customer', 'error', `üíì Heartbeat ba≈üarƒ±sƒ±z: ${response.message}`);
                    }
                }
            });
        }

        function toggleDriverAutoHeartbeat() {
            if (driverHeartbeatInterval) {
                clearInterval(driverHeartbeatInterval);
                driverHeartbeatInterval = null;
                document.getElementById('driverAutoHeartbeatBtn').textContent = 'Otomatik Heartbeat Ba≈ülat';
                updateHeartbeatStatus('driver', 'Heartbeat durumu: Kapalƒ±');
                addLog('driver', 'info', 'Otomatik heartbeat durduruldu');
            } else {
                driverHeartbeatInterval = setInterval(() => {
                    if (driverSocket && driverSocket.connected) {
                        sendDriverHeartbeat();
                    }
                }, 30000); // Her 30 saniyede bir (gateway'deki HEARTBEAT_INTERVAL)
                document.getElementById('driverAutoHeartbeatBtn').textContent = 'Otomatik Heartbeat Durdur';
                updateHeartbeatStatus('driver', 'Heartbeat durumu: Aktif (30s aralƒ±k)');
                addLog('driver', 'info', 'Otomatik heartbeat ba≈ülatƒ±ldƒ± (30s aralƒ±k)');
            }
        }

        function toggleCustomerAutoHeartbeat() {
            if (customerHeartbeatInterval) {
                clearInterval(customerHeartbeatInterval);
                customerHeartbeatInterval = null;
                document.getElementById('customerAutoHeartbeatBtn').textContent = 'Otomatik Heartbeat Ba≈ülat';
                updateHeartbeatStatus('customer', 'Heartbeat durumu: Kapalƒ±');
                addLog('customer', 'info', 'Otomatik heartbeat durduruldu');
            } else {
                customerHeartbeatInterval = setInterval(() => {
                    if (customerSocket && customerSocket.connected) {
                        sendCustomerHeartbeat();
                    }
                }, 30000); // Her 30 saniyede bir (gateway'deki HEARTBEAT_INTERVAL)
                document.getElementById('customerAutoHeartbeatBtn').textContent = 'Otomatik Heartbeat Durdur';
                updateHeartbeatStatus('customer', 'Heartbeat durumu: Aktif (30s aralƒ±k)');
                addLog('customer', 'info', 'Otomatik heartbeat ba≈ülatƒ±ldƒ± (30s aralƒ±k)');
            }
        }

        // Driver Login Functions
        async function initiateDriverLogin() {
            const apiUrl = document.getElementById('driverApiUrl').value;
            const phone = document.getElementById('driverPhone').value;

            if (!phone) {
                addLog('driver', 'error', 'Telefon numarasƒ± gerekli!');
                return;
            }

            try {
                addLog('driver', 'info', `Driver login ba≈ülatƒ±lƒ±yor: ${phone}`);
                
                const response = await fetch(`${apiUrl}/auth/driver/initiate-signin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phone: phone })
                });

                const data = await response.json();

                if (response.ok) {
                    addLog('driver', 'success', `OTP g√∂nderildi: ${JSON.stringify(data)}`);
                    
                    // Show OTP input and buttons
                    document.getElementById('driverOtpGroup').style.display = 'block';
                    document.getElementById('driverLoginBtn').style.display = 'none';
                    document.getElementById('driverOtpBtn').style.display = 'inline-block';
                    document.getElementById('driverResendBtn').style.display = 'inline-block';
                } else {
                    addLog('driver', 'error', `Login ba≈üarƒ±sƒ±z: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                addLog('driver', 'error', `Login hatasƒ±: ${error.message}`);
            }
        }

        async function completeDriverLogin() {
            const apiUrl = document.getElementById('driverApiUrl').value;
            const phone = document.getElementById('driverPhone').value;
            const otp = document.getElementById('driverOtp').value;

            if (!otp) {
                addLog('driver', 'error', 'OTP kodu gerekli!');
                return;
            }

            try {
                addLog('driver', 'info', `OTP doƒürulanƒ±yor: ${otp}`);
                
                const response = await fetch(`${apiUrl}/auth/driver/complete-signin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'device-id': 'websocket-test-dashboard'
                    },
                    body: JSON.stringify({ phone: phone, otp: otp })
                });

                const data = await response.json();

                if (response.ok && data.token) {
                    addLog('driver', 'success', `Login ba≈üarƒ±lƒ±! Token alƒ±ndƒ±.`);
                    
                    // Display token
                    document.getElementById('driverTokenDisplay').value = data.token;
                    document.getElementById('driverTokenGroup').style.display = 'block';
                    
                    // Auto-fill token field
                    document.getElementById('driverToken').value = data.token;
                    
                    // Reset UI
                    document.getElementById('driverOtpGroup').style.display = 'none';
                    document.getElementById('driverLoginBtn').style.display = 'inline-block';
                    document.getElementById('driverOtpBtn').style.display = 'none';
                    document.getElementById('driverResendBtn').style.display = 'none';
                    document.getElementById('driverOtp').value = '';
                } else {
                    addLog('driver', 'error', `OTP doƒürulama ba≈üarƒ±sƒ±z: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                addLog('driver', 'error', `OTP doƒürulama hatasƒ±: ${error.message}`);
            }
        }

        async function resendDriverOtp() {
            const apiUrl = document.getElementById('driverApiUrl').value;
            const phone = document.getElementById('driverPhone').value;

            try {
                addLog('driver', 'info', 'OTP yeniden g√∂nderiliyor...');
                
                const response = await fetch(`${apiUrl}/auth/driver/resend-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phone: phone })
                });

                const data = await response.json();

                if (response.ok) {
                    addLog('driver', 'success', `OTP yeniden g√∂nderildi: ${JSON.stringify(data)}`);
                } else {
                    addLog('driver', 'error', `OTP yeniden g√∂nderme ba≈üarƒ±sƒ±z: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                addLog('driver', 'error', `OTP yeniden g√∂nderme hatasƒ±: ${error.message}`);
            }
        }

        function copyDriverToken() {
            const tokenDisplay = document.getElementById('driverTokenDisplay');
            tokenDisplay.select();
            tokenDisplay.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(tokenDisplay.value);
            addLog('driver', 'success', 'Token panoya kopyalandƒ±!');
        }

        // Customer Login Functions
        async function initiateCustomerLogin() {
            const apiUrl = document.getElementById('customerApiUrl').value;
            const phone = document.getElementById('customerPhone').value;

            if (!phone) {
                addLog('customer', 'error', 'Telefon numarasƒ± gerekli!');
                return;
            }

            try {
                addLog('customer', 'info', `Customer login ba≈ülatƒ±lƒ±yor: ${phone}`);
                
                const response = await fetch(`${apiUrl}/auth/customer/initiate-signin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phone: phone })
                });

                const data = await response.json();

                if (response.ok) {
                    addLog('customer', 'success', `OTP g√∂nderildi: ${JSON.stringify(data)}`);
                    
                    // Show OTP input and buttons
                    document.getElementById('customerOtpGroup').style.display = 'block';
                    document.getElementById('customerLoginBtn').style.display = 'none';
                    document.getElementById('customerOtpBtn').style.display = 'inline-block';
                    document.getElementById('customerResendBtn').style.display = 'inline-block';
                } else {
                    addLog('customer', 'error', `Login ba≈üarƒ±sƒ±z: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                addLog('customer', 'error', `Login hatasƒ±: ${error.message}`);
            }
        }

        async function completeCustomerLogin() {
            const apiUrl = document.getElementById('customerApiUrl').value;
            const phone = document.getElementById('customerPhone').value;
            const otp = document.getElementById('customerOtp').value;

            if (!otp) {
                addLog('customer', 'error', 'OTP kodu gerekli!');
                return;
            }

            try {
                addLog('customer', 'info', `OTP doƒürulanƒ±yor: ${otp}`);
                
                const response = await fetch(`${apiUrl}/auth/customer/complete-signin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'device-id': 'websocket-test-dashboard'
                    },
                    body: JSON.stringify({ phone: phone, otp: otp })
                });

                const data = await response.json();

                if (response.ok && data.token) {
                    addLog('customer', 'success', `Login ba≈üarƒ±lƒ±! Token alƒ±ndƒ±.`);
                    
                    // Display token
                    document.getElementById('customerTokenDisplay').value = data.token;
                    document.getElementById('customerTokenGroup').style.display = 'block';
                    
                    // Auto-fill token field
                    document.getElementById('customerToken').value = data.token;
                    
                    // Reset UI
                    document.getElementById('customerOtpGroup').style.display = 'none';
                    document.getElementById('customerLoginBtn').style.display = 'inline-block';
                    document.getElementById('customerOtpBtn').style.display = 'none';
                    document.getElementById('customerResendBtn').style.display = 'none';
                    document.getElementById('customerOtp').value = '';
                } else {
                    addLog('customer', 'error', `OTP doƒürulama ba≈üarƒ±sƒ±z: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                addLog('customer', 'error', `OTP doƒürulama hatasƒ±: ${error.message}`);
            }
        }

        async function resendCustomerOtp() {
            const apiUrl = document.getElementById('customerApiUrl').value;
            const phone = document.getElementById('customerPhone').value;

            try {
                addLog('customer', 'info', 'OTP yeniden g√∂nderiliyor...');
                
                const response = await fetch(`${apiUrl}/auth/customer/resend-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phone: phone })
                });

                const data = await response.json();

                if (response.ok) {
                    addLog('customer', 'success', `OTP yeniden g√∂nderildi: ${JSON.stringify(data)}`);
                } else {
                    addLog('customer', 'error', `OTP yeniden g√∂nderme ba≈üarƒ±sƒ±z: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                addLog('customer', 'error', `OTP yeniden g√∂nderme hatasƒ±: ${error.message}`);
            }
        }

        function copyCustomerToken() {
            const tokenDisplay = document.getElementById('customerTokenDisplay');
            tokenDisplay.select();
            tokenDisplay.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(tokenDisplay.value);
            addLog('customer', 'success', 'Token panoya kopyalandƒ±!');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateConnectionStatus('driver', 'disconnected');
            updateConnectionStatus('customer', 'disconnected');
            updateLocationStatus('driver', 'Otomatik konum: Kapalƒ±');
            updateLocationStatus('customer', 'Otomatik konum: Kapalƒ±');
            
            addLog('driver', 'info', 'WebSocket Test Dashboard ba≈ülatƒ±ldƒ± - Gateway Uyumlu');
            addLog('customer', 'info', 'WebSocket Test Dashboard ba≈ülatƒ±ldƒ± - Gateway Uyumlu');
        });
    </script>
</body>
</html>